name: Main workflow

on:
  pull_request:
  schedule:
    # Prime the caches every Monday
    - cron: 0 1 * * MON

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os:
          - windows-latest
        ocaml-compiler:
          - 4.14.0

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Use OCaml ${{ matrix.ocaml-compiler }}
        uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: ocaml-variants.${{ matrix.ocaml-compiler }}+mingw64c,ocaml-config.2
          opam-repositories: |
            default: https://github.com/fdopen/opam-repository-mingw.git#opam2
            opam: https://github.com/ocaml/opam-repository.git

      - name: Manually install depexts (graphviz)
        run: opam exec -- cygwin-dl.exe --quiet-mode --root D:\cygwin --site https://cygwin.mirror.constant.com --symlink-type=sys --packages graphviz

      - name: Install Cap'n Proto
        shell: bash
        env:
          CAPNP_VERSION: 0.10.3
        run: |
          curl -LO https://capnproto.org/capnproto-c++-win32-$CAPNP_VERSION.zip && \
          unzip -j capnproto-c++-win32-$CAPNP_VERSION.zip capnproto-tools-win32-$CAPNP_VERSION/capnp.exe -d /usr/bin

      - name: Install opam locked dependencies
        run: |
          opam pin add -yn ocluster.dev './' && `
          opam pin add -yn ocluster-worker.dev './' && `
          opam pin add -yn ocluster-api.dev './' && `
          opam pin add -yn obuilder.dev 'obuilder/' && `
          opam pin add -yn obuilder-spec.dev 'obuilder/' && `
          opam pin add -yn current_ocluster.dev './' && `
          opam install alcotest.1.7.0 alcotest-lwt.1.7.0 angstrom.0.15.0 ansi.0.6.0 asetmap.0.8.1 asn1-combinators.0.2.6 astring.0.8.5 atd.2.11.0 atdgen.2.11.0 atdgen-runtime.2.11.0 base.v0.15.1 base-bigarray.base base-bytes.base base-threads.base base-unix.base base64.3.5.1 bigarray-compat.1.1.0 bigarray-overlap.0.2.1 bigstringaf.0.9.0 biniou.1.2.2 bos.0.2.1 ca-certs.0.2.3 camlp-streams.5.0.1 capnp.3.5.0 capnp-rpc.1.2.3 capnp-rpc-lwt.1.2.3 capnp-rpc-net.1.2.3 capnp-rpc-unix.1.2.3 cf.0.5.0 cf-lwt.0.5.0 checkseum.0.5.0 cmdliner.1.1.1 cohttp.5.0.0 cohttp-lwt.5.0.0 cohttp-lwt-unix.5.0.0 conduit.6.2.0 conduit-lwt.6.2.0 conduit-lwt-unix.6.2.0 conf-capnproto.2 conf-git.1.1 conf-gmp.4 conf-gmp-powm-sec.3 conf-graphviz.0.1 conf-libffi.2.0.0 conf-pkg-config.2 conf-sqlite3.1 conf-which.1 cppo.1.6.9 crunch.3.3.1 csexp.1.5.1 cstruct.6.1.1 cstruct-lwt.6.1.1 cstruct-sexp.6.1.1 csv.2.4 ctypes.0.20.1 ctypes-foreign.0.18.0 current.0.6.4 current_git.0.6.4 current_github.0.6.4 current_incr.0.6.1 current_ocluster.dev current_web.0.6.4 decompress.1.5.2 digestif.1.1.3 domain-name.0.4.0 dune.3.7.0 dune-build-info.3.7.0 dune-configurator.3.7.0 duration.0.2.1 easy-format.1.3.4 eqaf.0.9 extunix.0.4.1 fmt.0.9.0 fpath.0.7.3 fsevents.0.3.0 fsevents-lwt.0.3.0 github.4.4.1 github-data.4.4.1 github-unix.4.4.1 gmap.0.3.0 hex.1.5.0 hkdf.1.0.4 integers.0.7.0 ipaddr.5.3.1 ipaddr-sexp.5.3.1 irmin-watcher.0.5.0 jane-street-headers.v0.15.0 jsonm.1.0.1 jst-config.v0.15.1 ke.0.6 logs.0.7.0 lwt.5.6.1 lwt-dllist.1.0.1 macaddr.5.3.1 magic-mime.1.3.0 menhir.20220210 menhirLib.20220210 menhirSdk.20220210 mirage-clock.4.2.0 mirage-crypto.0.11.0 mirage-crypto-ec.0.11.0 mirage-crypto-pk.0.11.0 mirage-crypto-rng.0.11.0 mirage-crypto-rng-lwt.0.11.0 mirage-flow.3.0.0 mirage-kv.6.1.0 mtime.2.0.0 multipart_form.0.4.1 multipart_form-lwt.0.4.1 num.1.4 obuilder.dev obuilder-spec.dev ocaml-compiler-libs.v0.12.4 ocaml-config.2 ocaml-options-vanilla.1 ocaml-syntax-shims.1.0.0 ocamlbuild.0.14.2 ocamlfind.1.9.5 ocplib-endian.1.2 optint.0.3.0 parsexp.v0.15.0 pbkdf.1.2.0 pecu.0.6 ppx_assert.v0.15.0 ppx_base.v0.15.0 ppx_cold.v0.15.0 ppx_compare.v0.15.0 ppx_cstruct.6.1.1 ppx_derivers.1.2.1 ppx_deriving.5.2.1 ppx_deriving_yojson.3.7.0 ppx_enumerate.v0.15.0 ppx_expect.v0.15.1 ppx_hash.v0.15.0 ppx_here.v0.15.0 ppx_inline_test.v0.15.0 ppx_optcomp.v0.15.0 ppx_sexp_conv.v0.15.1 ppxlib.0.28.0 prettym.0.0.3 prometheus.1.2 prometheus-app.1.2 psq.0.2.1 ptime.1.1.0 re.1.10.4 res.5.0.1 result.1.5 routes.2.0.0 rresult.0.7.0 seq.base session.0.5.0 session-cohttp.0.5.0 session-cohttp-lwt.0.5.0 sexplib.v0.15.1 sexplib0.v0.15.1 sha.1.15.4 sqlite3.5.1.0 stdint.0.7.2 stdio.v0.15.0 stdlib-shims.0.3.0 stringext.1.6.0 tar.2.3.0 tar-unix.2.3.0 time_now.v0.15.0 tls.0.16.0 tls-lwt.0.16.0 tls-mirage.0.16.0 topkg.1.0.7 tyxml.4.5.0 uchar.0.0.2 unstrctrd.0.3 uri.4.2.0 uri-sexp.4.2.0 uutf.1.0.3 x509.0.16.4 yojson.2.0.2 zarith.1.12

      - run: opam exec -- dune build

      - run: opam exec -- dune runtest

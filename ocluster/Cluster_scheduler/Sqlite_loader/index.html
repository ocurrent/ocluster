<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sqlite_loader (ocluster.Cluster_scheduler.Sqlite_loader)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">ocluster</a> &#x00BB; <a href="../index.html">Cluster_scheduler</a> &#x00BB; Sqlite_loader</nav><header class="odoc-preamble"><h1>Module <code><span>Cluster_scheduler.Sqlite_loader</span></code></h1></header><div class="odoc-content"><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="xref-unresolved">Capnp_rpc_net</span>.Restorer.LOADER</span></code></summary><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hash"><a href="#val-hash" class="anchor"></a><code><span><span class="keyword">val</span> hash : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Capnp_rpc_net</span>.Auth.hash</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-make_sturdy"><a href="#val-make_sturdy" class="anchor"></a><code><span><span class="keyword">val</span> make_sturdy : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Capnp_rpc_net</span>.Restorer.Id.t <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Uri</span>.t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-load"><a href="#val-load" class="anchor"></a><code><span><span class="keyword">val</span> load : 
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'a</span> <span class="xref-unresolved">Capnp_rpc_lwt</span>.Sturdy_ref.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Capnp_rpc_net</span>.Restorer.resolution <span class="xref-unresolved">Lwt</span>.t</span></span></code></div></div></details></div><div class="odoc-spec"><div class="spec module anchored" id="module-Ty"><a href="#module-Ty" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Ty/index.html">Ty</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>The database can store different types of resource. It uses strings to identify them, but the rest of the code uses OCaml types. This module maintains a mapping between type names and OCaml types.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-descr"><a href="#type-descr" class="anchor"></a><code><span><span class="keyword">type</span> descr</span><span> = <a href="Ty/index.html#type-t">Ty.t</a> * string</span></code></div><div class="spec-doc"><p>A <code>descr</code> contains the information stored in the database which is used to restore a capability. This string are the &quot;arguments&quot;, passed to the user's <code>load</code> function.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-digest"><a href="#type-digest" class="anchor"></a><code><span><span class="keyword">type</span> digest</span><span> = <span class="keyword">private</span> string</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : 
  <span><span class="label">make_sturdy</span>:<span>(<span><span class="xref-unresolved">Capnp_rpc_net</span>.Restorer.Id.t <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Uri</span>.t)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">load</span>:
    <span>(<span><span class="label">validate</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> bool)</span> <span class="arrow">&#45;&gt;</span></span>
      <span><span class="label">sturdy_ref</span>:<span><span class="type-var">'a</span> <span class="xref-unresolved">Capnp_rpc_lwt</span>.Sturdy_ref.t</span> <span class="arrow">&#45;&gt;</span></span>
      <span><a href="#type-descr">descr</a> <span class="arrow">&#45;&gt;</span></span>
      <span><span class="xref-unresolved">Capnp_rpc_net</span>.Restorer.resolution <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../Db/index.html#type-t">Db.t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create ~make_sturdy ~load db</code> is a loader that persists information about sturdy refs in an sqlite3 database. <code>make_sturdy</code> converts a secret ID to a sturdy URI. Use e.g. <code>Capnp_rpc_unix.Vat_config.sturdy_uri</code> for this. When a request for a previously-issued sturdy ref arrives, the loader gets the type and arguments for the object from the database and then calls <code>load ~validate ~sturdy_ref descr</code> to create the live ref. <code>sturdy_ref</code> is the object's own sturdy-ref, which it may want to hand back to clients (e.g. if implementing the persistence API). <code>validate</code> can be used to check whether the object is still in the table, to handle revocation.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add"><a href="#val-add" class="anchor"></a><code><span><span class="keyword">val</span> add : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-descr">descr</a> <span class="arrow">&#45;&gt;</span></span> <span class="xref-unresolved">Capnp_rpc_net</span>.Restorer.Id.t</span></code></div><div class="spec-doc"><p><code>add t descr</code> generates and returns new secret ID. It also adds <code>descr</code> to the database under the hash of this secret. If a user later uses the secret to connect, <code>descr</code> will be used to load the object.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-remove"><a href="#val-remove" class="anchor"></a><code><span><span class="keyword">val</span> remove : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-digest">digest</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>remove t hash</code> removes the entry with the given hash, if any.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Not_found</code> <p>if <code>digest</code> is not present.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-list_by_type"><a href="#val-list_by_type" class="anchor"></a><code><span><span class="keyword">val</span> list_by_type : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="Ty/index.html#type-t">Ty.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="#type-digest">digest</a> * string)</span> list</span></span></code></div><div class="spec-doc"><p><code>list_by_type t ty</code> returns all entries <code>(digest, args)</code> with the given <code>ty</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-lookup_by_descr"><a href="#val-lookup_by_descr" class="anchor"></a><code><span><span class="keyword">val</span> lookup_by_descr : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-descr">descr</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-digest">digest</a> list</span></span></code></div><div class="spec-doc"><p><code>lookup_by_descr t descr</code> returns all entries with the given type and arguments.</p></div></div></div></body></html>

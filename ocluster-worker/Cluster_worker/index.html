<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Cluster_worker (ocluster-worker.Cluster_worker)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">ocluster-worker</a> &#x00BB; Cluster_worker</nav><header class="odoc-preamble"><h1>Module <code><span>Cluster_worker</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-job_spec"><a href="#type-job_spec" class="anchor"></a><code><span><span class="keyword">type</span> job_spec</span><span> = </span><span>[ </span></code><ol><li id="type-job_spec.Docker" class="def variant constructor anchored"><a href="#type-job_spec.Docker" class="anchor"></a><code><span>| </span><span>`Docker <span class="keyword">of</span>
  <span>[ <span>`Contents of string</span> <span><span>| `Path</span> of string</span> ]</span> * <a href="../../ocluster-api/Cluster_api/Docker/Spec/index.html#type-options">Cluster_api.Docker.Spec.options</a></span></code></li><li id="type-job_spec.Obuilder" class="def variant constructor anchored"><a href="#type-job_spec.Obuilder" class="anchor"></a><code><span>| </span><span>`Obuilder <span class="keyword">of</span> <span>[ <span>`Contents of string</span> ]</span></span></code></li><li id="type-job_spec.Custom" class="def variant constructor anchored"><a href="#type-job_spec.Custom" class="anchor"></a><code><span>| </span><span>`Custom <span class="keyword">of</span> <a href="../../ocluster-api/Cluster_api/Custom/index.html#type-recv">Cluster_api.Custom.recv</a></span></code></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Obuilder_config"><a href="#module-Obuilder_config" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Obuilder_config/index.html">Obuilder_config</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-build"><a href="#type-build" class="anchor"></a><code><span><span class="keyword">type</span> build</span><span> =
  <span><span class="label">switch</span>:<span class="xref-unresolved">Lwt_switch</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">log</span>:<a href="Log_data/index.html#type-t">Log_data.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">src</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">secrets</span>:<span><span>(string * string)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-job_spec">job_spec</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(string, <span>[ `Cancelled <span><span>| `Msg</span> of string</span> ]</span>)</span> <span class="xref-unresolved">Lwt_result</span>.t</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-default_build"><a href="#val-default_build" class="anchor"></a><code><span><span class="keyword">val</span> default_build : <span><span class="optlabel">?obuilder</span>:<span class="xref-unresolved">Cluster_worker__.Obuilder_build.t</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-build">build</a></span></code></div><div class="spec-doc"><p>The default build that is used if no <code>build</code> argument is given to <a href="#val-run"><code>run</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-run"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : 
  <span><span class="optlabel">?switch</span>:<span class="xref-unresolved">Lwt_switch</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?build</span>:<a href="#type-build">build</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?allow_push</span>:<span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">healthcheck_period</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?prune_threshold</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?docker_max_df_size</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?obuilder_prune_threshold</span>:float <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?obuilder_prune_item_threshold</span>:int64 <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?obuilder_prune_limit</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?obuilder</span>:<a href="Obuilder_config/index.html#type-t">Obuilder_config.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?additional_metrics</span>:<span><span>(string * <span class="xref-unresolved">Uri</span>.t)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">update</span>:<span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="xref-unresolved">Lwt</span>.t</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">capacity</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">state_dir</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../ocluster-api/Cluster_api/Raw/Client/Registration/index.html#type-t">Cluster_api.Raw.Client.Registration.t</a> <span class="xref-unresolved">Capnp_rpc_lwt</span>.Sturdy_ref.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span>unit <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>run ~capacity ~name ~state_dir registry</code> runs a builder that connects to registry and runs up to <code>capacity</code> jobs at once. The builder registers using the unique ID <code>name</code>.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">switch</span> <p>Turning this off causes the builder to exit (for unit-tests).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">build</span> <p>Used to override the default build action (for unit-tests or custom job specifications).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">allow_push</span> <p>Docker repositories to which results can be pushed.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">healthcheck_period</span> <p>Time period, in seconds, at which the health of the worker is checked.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">prune_threshold</span> <p>Stop and run <code>docker system prune -af</code> if free-space is less than this percentage (0 to 100).</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">docker_max_df_size</span> <p>Run <code>docker system df</code> to get the amount of memory being taken up by the images and if this is greater than <code>docker_max_df_size</code>, run <code>docker system prune</code>.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">obuilder_prune_threshold</span> <p>The threshold for OBuilder to prune the store of cached build steps.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">obuilder</span> <p>OBuilder's configuration.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">additional_metrics</span> <p>A list of additional prometheus endpoints with a descriptive name to collect.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">update</span> <p>Function to run on &quot;selfUpdate&quot; requests. It should do any preparation (such as downloading new images), then return a function to do the actual update. This is so that the first part can run while the node finishes its remaining jobs. The second part is called once all jobs are finished. If the second function returns, the process will exit.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">capacity</span> <p>The number of builds that can run in parallel.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">name</span> <p>Unique builder name.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">state_dir</span> <p>A persistent directory for Git caches, etc.</p></li></ul></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Process"><a href="#module-Process" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Process/index.html">Process</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Log_data"><a href="#module-Log_data" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Log_data/index.html">Log_data</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div></div></body></html>
